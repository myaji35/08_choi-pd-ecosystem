name: Scheduled GCP Deployment

on:
  schedule:
    # í•œêµ­ì‹œê°„ ìì • (UTC 15:00 = KST 00:00)
    - cron: '0 15 * * *'

  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  NODE_VERSION: '18'
  GCP_HOST: '34.64.191.91'
  GCP_PORT: '8000'
  DEPLOY_PATH: '~/choi-pd-ecosystem'

jobs:
  deploy:
    name: Deploy to GCP Server
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“… Deployment Info
        run: |
          echo "ğŸš€ ìë™ ë°°í¬ ì‹œì‘"
          echo "ë°°í¬ ì‹œê°„ (KST): $(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S')"
          echo "ë°°í¬ ëŒ€ìƒ: ${{ env.GCP_HOST }}:${{ env.GCP_PORT }}"

      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          path: choi-pd-ecosystem

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './choi-pd-ecosystem/package-lock.json'

      - name: ğŸ“¦ Install dependencies
        working-directory: ./choi-pd-ecosystem
        run: npm ci

      - name: ğŸ—ï¸ Build application
        working-directory: ./choi-pd-ecosystem
        run: |
          echo "Building for production..."
          npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_DEV_MODE: false
          NEXT_PUBLIC_APP_URL: http://${{ env.GCP_HOST }}:${{ env.GCP_PORT }}
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ secrets.CLERK_PUBLISHABLE_KEY }}
          DATABASE_URL: file:./data/database.db

      - name: ğŸ“ Prepare deployment files
        working-directory: ./choi-pd-ecosystem
        run: |
          # .env.production íŒŒì¼ ìƒì„±
          cat > .env.production << EOF
          NODE_ENV=production
          PORT=${{ env.GCP_PORT }}
          DATABASE_URL=file:./data/database.db
          NEXT_PUBLIC_APP_URL=http://${{ env.GCP_HOST }}:${{ env.GCP_PORT }}
          NEXT_PUBLIC_DEV_MODE=false
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=${{ secrets.CLERK_PUBLISHABLE_KEY }}
          CLERK_SECRET_KEY=${{ secrets.CLERK_SECRET_KEY }}
          ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}
          EOF

          # ì••ì¶• íŒŒì¼ ìƒì„±
          tar -czf deploy.tar.gz \
            .next \
            public \
            package.json \
            package-lock.json \
            next.config.js \
            src/lib \
            src/styles \
            src/components \
            .env.production \
            data \
            ecosystem.config.js

          echo "âœ… ë°°í¬ íŒŒì¼ ì¤€ë¹„ ì™„ë£Œ ($(du -h deploy.tar.gz | cut -f1))"

      - name: ğŸ”‘ Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GCP_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.GCP_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ“¤ Transfer files to GCP
        working-directory: ./choi-pd-ecosystem
        run: |
          echo "íŒŒì¼ ì „ì†¡ ì¤‘..."
          scp -i ~/.ssh/id_rsa deploy.tar.gz ${{ secrets.GCP_USER }}@${{ env.GCP_HOST }}:~/
          echo "âœ… íŒŒì¼ ì „ì†¡ ì™„ë£Œ"

      - name: ğŸš€ Deploy on GCP server
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.GCP_USER }}@${{ env.GCP_HOST }} << 'ENDSSH'
            set -e

            echo "ğŸ”§ ì„œë²„ ë°°í¬ ì‹œì‘..."

            # ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p ~/choi-pd-ecosystem
            cd ~/choi-pd-ecosystem

            # ê¸°ì¡´ íŒŒì¼ ë°±ì—…
            if [ -d ".next" ]; then
              echo "ğŸ“¦ ê¸°ì¡´ ë²„ì „ ë°±ì—… ì¤‘..."
              mv .next .next.backup-$(date +%Y%m%d%H%M%S)
            fi

            # ì••ì¶• í•´ì œ
            echo "ğŸ“‚ íŒŒì¼ ì••ì¶• í•´ì œ ì¤‘..."
            tar -xzf ~/deploy.tar.gz

            # ì¢…ì†ì„± ì„¤ì¹˜
            echo "ğŸ“š ì¢…ì†ì„± ì„¤ì¹˜ ì¤‘..."
            npm ci --production

            # PM2ë¡œ ì„œë¹„ìŠ¤ ì¬ì‹œì‘
            echo "â™»ï¸ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì¤‘..."
            if pm2 list | grep -q "impd-ecosystem"; then
              pm2 restart impd-ecosystem
            else
              pm2 start ecosystem.config.js
              pm2 save
              pm2 startup || true
            fi

            # ì •ë¦¬
            rm ~/deploy.tar.gz

            # ìƒíƒœ í™•ì¸
            pm2 status impd-ecosystem

            echo "âœ… ë°°í¬ ì™„ë£Œ!"
            echo "ğŸŒ URL: http://${{ env.GCP_HOST }}:${{ env.GCP_PORT }}"
          ENDSSH

      - name: âœ… Health check
        run: |
          echo "í—¬ìŠ¤ ì²´í¬ ì¤‘..."
          sleep 10

          response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ env.GCP_HOST }}:${{ env.GCP_PORT }}/api/health || echo "000")

          if [ "$response" = "200" ]; then
            echo "âœ… ì„œë²„ê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤!"
          else
            echo "âš ï¸ ì„œë²„ ì‘ë‹µ ì½”ë“œ: $response"
            echo "ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
          fi

      - name: ğŸ“§ Deployment notification
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨';
            const kstTime = new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' });

            const message = `
            ## ğŸš€ ìë™ ë°°í¬ ê²°ê³¼: ${status}

            - **ë°°í¬ ì‹œê°„ (KST)**: ${kstTime}
            - **ì„œë²„**: ${{ env.GCP_HOST }}:${{ env.GCP_PORT }}
            - **ë¸Œëœì¹˜**: ${{ github.ref }}
            - **ì»¤ë°‹**: ${{ github.sha }}
            `;

            // Issue ì½”ë©˜íŠ¸ë¡œ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
            // github.rest.issues.createComment({
            //   issue_number: 1,  // ì•Œë¦¼ì„ ë°›ì„ ì´ìŠˆ ë²ˆí˜¸
            //   owner: context.repo.owner,
            //   repo: context.repo.repo,
            //   body: message
            // });

            console.log(message);

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa
          rm -rf ./choi-pd-ecosystem/deploy.tar.gz